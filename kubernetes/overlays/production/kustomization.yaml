apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: feature-builder-production

resources:
  - ../../base

nameSuffix: -production

patches:
  # Update ingress host
  - patch: |-
      - op: replace
        path: /spec/rules/0/host
        value: build.antinvestor.com
    target:
      kind: Ingress
      name: feature-builder

  # Add TLS to ingress
  - patch: |-
      - op: add
        path: /spec/tls
        value:
          - hosts:
              - build.antinvestor.com
            secretName: feature-builder-tls
    target:
      kind: Ingress
      name: feature-builder

  # Increase worker replicas
  - patch: |-
      - op: replace
        path: /spec/replicas
        value: 5
    target:
      kind: Deployment
      name: worker

configMapGenerator:
  - name: feature-builder-config
    behavior: merge
    literals:
      - LOG_LEVEL=info
      - MAX_RISK_SCORE=40
      - MAX_ITERATIONS=3

labels:
  - pairs:
      environment: production
    includeSelectors: false

images:
  - name: ghcr.io/antinvestor/builder-webhook
    newTag: v0.1.0
  - name: ghcr.io/antinvestor/builder-gateway
    newTag: v0.1.0
  - name: ghcr.io/antinvestor/builder-worker
    newTag: v0.1.0
  - name: ghcr.io/antinvestor/builder-reviewer
    newTag: v0.1.0
  - name: ghcr.io/antinvestor/builder-executor
    newTag: v0.1.0
